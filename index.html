<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Football Fury: Career Mode</title>
  <style>
    :root {
      color-scheme: dark;
      font-family: "Trebuchet MS", Arial, sans-serif;
    }

    body {
      margin: 0;
      background: #0a0f14;
      color: #f7f7f7;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    #game-wrapper {
      width: min(1080px, 96vw);
      background: #111926;
      border-radius: 18px;
      box-shadow: 0 18px 50px rgba(0, 0, 0, 0.45);
      overflow: hidden;
      display: grid;
      grid-template-columns: 3fr 1.1fr;
    }

    #game-panel {
      position: relative;
      background: radial-gradient(circle at top, #0c5b2b, #072a14 55%, #061a0f 100%);
    }

    #game-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    #hud {
      position: absolute;
      inset: 12px 12px auto 12px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .hud-card {
      background: rgba(8, 14, 24, 0.75);
      border-radius: 10px;
      padding: 8px 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      min-width: 120px;
    }

    .scoreboard {
      min-width: 220px;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.8px;
      background: linear-gradient(135deg, rgba(35, 50, 72, 0.9), rgba(11, 17, 28, 0.95));
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.05);
    }

    .scoreboard strong {
      font-size: 18px;
      letter-spacing: 1.2px;
    }

    #side-panel {
      background: #0f1520;
      padding: 18px;
      border-left: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    h1, h2 {
      margin: 0 0 8px;
    }

    h1 {
      font-size: 20px;
    }

    h2 {
      font-size: 16px;
      color: #9bd0ff;
    }

    .panel-card {
      background: rgba(15, 22, 34, 0.9);
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    button {
      background: #1f7aff;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease;
    }

    button:hover {
      transform: translateY(-1px);
    }

    button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
      transform: none;
    }

    button.secondary {
      background: #2a3445;
    }

    .tag {
      display: inline-block;
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      font-size: 12px;
      margin-right: 6px;
    }

    .list {
      display: grid;
      gap: 6px;
      font-size: 13px;
    }

    .meter {
      height: 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.12);
      overflow: hidden;
      margin-top: 6px;
    }

    .meter > span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, #31d48c, #12b3ff);
      width: 40%;
    }

    #overlay {
      position: absolute;
      inset: 0;
      background: rgba(8, 12, 18, 0.78);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      backdrop-filter: blur(4px);
    }

    .modal {
      background: #101929;
      border-radius: 16px;
      padding: 20px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .modal h2 {
      margin-top: 0;
    }

    label {
      font-size: 12px;
      color: #9fb2cc;
      display: block;
      margin-top: 10px;
    }

    input, select {
      width: 100%;
      padding: 6px 8px;
      margin-top: 4px;
      background: #182234;
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: #fff;
      border-radius: 8px;
    }

    .row {
      display: flex;
      gap: 10px;
    }

    .row > * {
      flex: 1;
    }

    .key-list {
      font-size: 12px;
      color: #afc4df;
      line-height: 1.4;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
      font-size: 12px;
    }

    .stat {
      display: flex;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.05);
      padding: 6px 8px;
      border-radius: 8px;
    }

    .upgrade-button {
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 6px;
    }

    .tiny {
      font-size: 11px;
      color: #91a4bd;
    }

    @media (max-width: 900px) {
      #game-wrapper {
        grid-template-columns: 1fr;
      }

      #side-panel {
        border-left: none;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }
    }
  </style>
</head>
<body>
  <div id="game-wrapper">
    <section id="game-panel">
      <canvas id="game-canvas" width="960" height="600"></canvas>
      <div id="hud">
        <div class="hud-card scoreboard" id="hud-scoreboard"></div>
        <div class="hud-card" id="hud-info"></div>
        <div class="hud-card" id="hud-xp"></div>
      </div>
      <div id="overlay" hidden></div>
    </section>
    <aside id="side-panel">
      <div class="panel-card">
        <h1>Football Fury: Career</h1>
        <div class="list" id="career-summary"></div>
      </div>
      <div class="panel-card">
        <h2>Play Call</h2>
        <div class="list" id="play-call"></div>
      </div>
      <div class="panel-card">
        <h2>Season Center</h2>
        <div class="list" id="season-actions"></div>
      </div>
      <div class="panel-card">
        <h2>Controls</h2>
        <div class="key-list">
          Move: WASD / Arrow Keys<br />
          Snap Ball: Space (QB/RB/WR on offense)<br />
          Action: F = Pass, R = Run, T = Tackle<br />
          Change Play: 1 / 2 / 3<br />
          Pause: Esc
        </div>
      </div>
      <div class="panel-card">
        <h2>Career Timeline</h2>
        <div class="list" id="timeline"></div>
      </div>
      <div class="panel-card">
        <h2>Team Roster</h2>
        <div class="list" id="roster-panel"></div>
      </div>
    </aside>
  </div>

  <script>
    const canvas = document.getElementById("game-canvas");
    const ctx = canvas.getContext("2d");
    const overlay = document.getElementById("overlay");
    const hudScoreboard = document.getElementById("hud-scoreboard");
    const hudInfo = document.getElementById("hud-info");
    const hudXp = document.getElementById("hud-xp");
    const careerSummary = document.getElementById("career-summary");
    const playCallPanel = document.getElementById("play-call");
    const seasonActions = document.getElementById("season-actions");
    const timelinePanel = document.getElementById("timeline");
    const rosterPanel = document.getElementById("roster-panel");

    const FIELD = {
      width: canvas.width,
      height: canvas.height,
      endZoneHeight: 60,
      hashSpacing: 40,
    };

    const gameState = {
      screen: "menu",
      paused: false,
      lastTime: 0,
      keys: new Set(),
    };

    const CAREER_STAGES = ["High School", "College", "NFL"];

    const TEAM_POOLS = {
      "High School": [
        { name: "River Hawks", abbr: "RVH", colors: ["#1d4ed8", "#0ea5e9"] },
        { name: "Mesa Wolves", abbr: "MSW", colors: ["#f97316", "#facc15"] },
        { name: "Oak Titans", abbr: "OAK", colors: ["#16a34a", "#22c55e"] },
        { name: "Metro Knights", abbr: "MTK", colors: ["#7c3aed", "#a855f7"] },
      ],
      College: [
        { name: "Western Tech", abbr: "WTC", colors: ["#22c55e", "#0f172a"] },
        { name: "North State", abbr: "NST", colors: ["#38bdf8", "#0f172a"] },
        { name: "Coastal U", abbr: "CSU", colors: ["#f97316", "#0f172a"] },
        { name: "Metro U", abbr: "MTU", colors: ["#a855f7", "#0f172a"] },
        { name: "Capital College", abbr: "CPC", colors: ["#facc15", "#1f2937"] },
      ],
      NFL: [
        { name: "Gotham Guardians", abbr: "GCG", colors: ["#ef4444", "#0f172a"] },
        { name: "Bay City Armada", abbr: "BCA", colors: ["#0ea5e9", "#0f172a"] },
        { name: "Prairie Outlaws", abbr: "PRO", colors: ["#f97316", "#1f2937"] },
        { name: "Capital Comets", abbr: "CPC", colors: ["#22c55e", "#0f172a"] },
        { name: "Sunset Kings", abbr: "SSK", colors: ["#facc15", "#0f172a"] },
        { name: "Harbor Legion", abbr: "HBL", colors: ["#6366f1", "#111827"] },
      ],
    };

    const positionTemplates = {
      QB: { skill: "Throw Power", color: "#4ad4ff" },
      RB: { skill: "Elusiveness", color: "#ffad4a" },
      WR: { skill: "Catching", color: "#caff7a" },
      CB: { skill: "Coverage", color: "#ff6b9c" },
      LB: { skill: "Tackling", color: "#ffc857" },
    };

    const defaultCareer = () => ({
      player: {
        name: "",
        position: "QB",
        school: "",
        number: 12,
        stats: {
          speed: 58,
          accel: 56,
          strength: 59,
          awareness: 55,
          skill: 58,
          stamina: 60,
        },
        xp: 0,
        level: 1,
        ovr: 58,
      },
      stageIndex: 0,
      week: 1,
      seasonLength: 4,
      stageWins: 0,
      stageLosses: 0,
      team: TEAM_POOLS["High School"][0],
      roster: [],
      schedule: [],
      results: [],
      currentOpponent: TEAM_POOLS["High School"][1],
      draftStock: 45,
      draftPick: null,
      totalAwards: 0,
      offers: [],
      difficulty: 1,
      savedAt: Date.now(),
    });

    let career = loadCareer() || defaultCareer();
    let hasSave = Boolean(loadCareer());

    const playbook = [
      { id: 1, name: "Inside Zone", type: "run", description: "Follow blockers and burst." },
      { id: 2, name: "Quick Slant", type: "pass", description: "Hit WR in stride." },
      { id: 3, name: "Blitz Read", type: "defense", description: "Attack downhill." },
    ];

    const match = {
      quarterLength: 180,
      clock: 180,
      quarter: 1,
      score: { us: 0, them: 0 },
      possession: "us",
      down: 1,
      yardsToGo: 10,
      ball: { x: FIELD.width / 2, y: FIELD.height - 120, owner: "player" },
      playActive: false,
      playType: "run",
      message: "",
      airTarget: null,
    };

    const player = {
      x: FIELD.width / 2,
      y: FIELD.height - 140,
      radius: 14,
      speed: 120,
      velocity: { x: 0, y: 0 },
      target: null,
      hasBall: true,
      stamina: 100,
      tackleCooldown: 0,
    };

    const spriteAssets = {
      frames: [],
    };

    const teammates = [];
    const opponents = [];

    function initActors() {
      teammates.length = 0;
      opponents.length = 0;
      for (let i = 0; i < 4; i += 1) {
        teammates.push({
          x: 180 + i * 120,
          y: FIELD.height - 180 - i * 10,
          radius: 11,
          role: i === 1 ? "WR" : "BLOCK",
        });
      }
      for (let i = 0; i < 5; i += 1) {
        opponents.push({
          x: 150 + i * 130,
          y: 140 + (i % 2) * 60,
          radius: 12,
          speed: 80 + i * 6,
        });
      }
    }

    function calculateOvr(stats) {
      const values = Object.values(stats);
      const avg = values.reduce((acc, val) => acc + val, 0) / values.length;
      return Math.min(99, Math.round(avg));
    }

    function updatePlayerStats() {
      const { stats } = career.player;
      career.player.ovr = calculateOvr(stats);
      player.speed = 80 + (stats.speed - 50) * 2;
    }

    function resetMatch() {
      match.clock = match.quarterLength;
      match.quarter = 1;
      match.score.us = 0;
      match.score.them = 0;
      match.possession = "us";
      match.down = 1;
      match.yardsToGo = 10;
      match.playActive = false;
      match.playType = "run";
      match.message = "";
      match.ball = { x: FIELD.width / 2, y: FIELD.height - 120, owner: "player" };
      match.airTarget = null;
      player.x = FIELD.width / 2;
      player.y = FIELD.height - 140;
      player.hasBall = true;
      player.stamina = 100;
      initActors();
    }

    function stageName() {
      return CAREER_STAGES[career.stageIndex];
    }

    function stageTeams() {
      return TEAM_POOLS[stageName()] || TEAM_POOLS["High School"];
    }

    function assignTeam() {
      const availableTeams = stageTeams();
      if (!career.team || !availableTeams.find((team) => team.name === career.team.name)) {
        career.team = availableTeams[Math.floor(Math.random() * availableTeams.length)];
      }
    }

    function generateRoster() {
      const positions = ["QB", "RB", "WR", "WR", "TE", "LT", "RG", "CB", "LB", "FS"];
      career.roster = positions.map((pos, index) => ({
        name: `${pos}-${index + 1}`,
        position: pos,
        ovr: 60 + Math.floor(Math.random() * 20) + career.stageIndex * 8,
      }));
      career.roster.unshift({
        name: career.player.name || "Rookie",
        position: career.player.position,
        ovr: career.player.ovr,
      });
    }

    function generateSchedule() {
      const teams = stageTeams().filter((team) => team.name !== career.team.name);
      career.schedule = [];
      career.results = [];
      for (let week = 0; week < career.seasonLength; week += 1) {
        const opponent = teams[week % teams.length];
        career.schedule.push(opponent);
        career.results.push({ week: week + 1, opponent, result: "TBD", score: "" });
      }
      career.currentOpponent = career.schedule[career.week - 1] || teams[0];
    }

    function stageDifficulty() {
      return 1 + career.stageIndex * 0.6 + career.difficulty * 0.2;
    }

    function calculateXpGain() {
      const base = 150 + match.score.us * 40;
      const milestone = match.score.us >= 2 ? 120 : 0;
      const defenseBonus = match.score.them === 0 ? 80 : 0;
      return Math.round(base + milestone + defenseBonus);
    }

    function applyXp() {
      const xpGain = calculateXpGain();
      career.player.xp += xpGain;
      if (match.score.us > match.score.them) {
        career.stageWins += 1;
      } else {
        career.stageLosses += 1;
      }
      career.results[career.week - 1] = {
        week: career.week,
        opponent: career.currentOpponent,
        result: match.score.us > match.score.them ? "W" : "L",
        score: `${match.score.us}-${match.score.them}`,
      };
      if (match.score.us >= 2) {
        career.totalAwards += 1;
      }
      career.week += 1;
      if (career.week > career.seasonLength) {
        advanceStage();
      } else {
        career.currentOpponent = career.schedule[career.week - 1];
      }
      saveCareer();
    }

    function advanceStage() {
      career.week = 1;
      career.stageIndex = Math.min(career.stageIndex + 1, CAREER_STAGES.length - 1);
      career.stageWins = 0;
      career.stageLosses = 0;
      assignTeam();
      generateRoster();
      generateSchedule();
      if (career.stageIndex === 1) {
        career.offers = ["North State", "Western Tech", "Coastal U"].slice(0, 2 + Math.floor(career.player.ovr / 25));
      }
      if (career.stageIndex === 2) {
        career.draftStock = Math.min(99, career.player.ovr + career.totalAwards * 2);
        runDraft();
      }
    }

    function runDraft() {
      const teams = TEAM_POOLS.NFL;
      const pick = Math.max(1, 32 - Math.floor(career.draftStock / 3));
      career.draftPick = pick;
      const team = teams[pick % teams.length];
      career.team = team;
      generateRoster();
    }

    function saveCareer() {
      career.savedAt = Date.now();
      localStorage.setItem("footballFuryCareer", JSON.stringify(career));
      hasSave = true;
    }

    function loadCareer() {
      const raw = localStorage.getItem("footballFuryCareer");
      if (!raw) return null;
      try {
        return JSON.parse(raw);
      } catch (error) {
        return null;
      }
    }

    function clearCareer() {
      localStorage.removeItem("footballFuryCareer");
      career = defaultCareer();
      hasSave = false;
      resetMatch();
      showMenu();
    }

    function showOverlay(content) {
      overlay.innerHTML = "";
      overlay.appendChild(content);
      overlay.hidden = false;
    }

    function hideOverlay() {
      overlay.hidden = true;
    }

    function showMenu() {
      gameState.screen = "menu";
      hasSave = Boolean(loadCareer());
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.innerHTML = `
        <h2>Start Your Career</h2>
        <p class="tiny">Build a player, call plays, and climb from high school to the NFL.</p>
        <div class="row">
          <button id="new-career">New Career</button>
          <button id="continue-career" class="secondary" ${hasSave ? "" : "disabled"}>Continue</button>
        </div>
        <div class="row" style="margin-top: 10px;">
          <button id="upgrade-menu" class="secondary">Upgrade Player</button>
          <button id="clear-save" class="secondary">Clear Save</button>
        </div>
      `;
      showOverlay(modal);
      modal.querySelector("#new-career").addEventListener("click", () => {
        career = defaultCareer();
        showCreator();
      });
      modal.querySelector("#continue-career").addEventListener("click", () => {
        if (!hasSave) return;
        career = loadCareer() || defaultCareer();
        assignTeam();
        if (!career.roster?.length) generateRoster();
        if (!career.schedule?.length) generateSchedule();
        career.currentOpponent = career.schedule[career.week - 1];
        updatePlayerStats();
        resetMatch();
        hideOverlay();
        gameState.screen = "game";
      });
      modal.querySelector("#upgrade-menu").addEventListener("click", showUpgradeMenu);
      modal.querySelector("#clear-save").addEventListener("click", clearCareer);
    }

    function showCreator() {
      gameState.screen = "creator";
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.innerHTML = `
        <h2>Character Creator</h2>
        <label>Name</label>
        <input id="player-name" placeholder="Your name" value="${career.player.name}" />
        <label>Position</label>
        <select id="player-position">
          ${Object.keys(positionTemplates)
            .map((pos) => `<option value="${pos}" ${pos === career.player.position ? "selected" : ""}>${pos}</option>`)
            .join("")}
        </select>
        <label>High School</label>
        <input id="player-school" placeholder="High school" value="${career.player.school}" />
        <div class="row" style="margin-top: 12px;">
          <button id="start-career">Start Career</button>
          <button id="back" class="secondary">Back</button>
        </div>
      `;
      showOverlay(modal);
      modal.querySelector("#start-career").addEventListener("click", () => {
        career.player.name = modal.querySelector("#player-name").value || "Rookie";
        career.player.position = modal.querySelector("#player-position").value;
        career.player.school = modal.querySelector("#player-school").value || "Central HS";
        assignTeam();
        generateRoster();
        generateSchedule();
        resetMatch();
        updatePlayerStats();
        saveCareer();
        hasSave = true;
        hideOverlay();
        gameState.screen = "game";
      });
      modal.querySelector("#back").addEventListener("click", showMenu);
    }

    function showUpgradeMenu() {
      gameState.screen = "upgrade";
      const { stats } = career.player;
      const modal = document.createElement("div");
      modal.className = "modal";
      const entries = Object.entries(stats)
        .map(
          ([key, value]) => `
            <div class="stat">
              <span>${key.toUpperCase()}</span>
              <span>${value}</span>
            </div>
            <button class="upgrade-button" data-stat="${key}">Upgrade</button>
          `
        )
        .join("");
      modal.innerHTML = `
        <h2>Upgrade Player</h2>
        <p class="tiny">Spend XP to raise stats. Costs scale with rating and stage.</p>
        <div class="stat-grid">${entries}</div>
        <div class="meter"><span style="width:${Math.min(100, career.player.xp / 10)}%"></span></div>
        <p class="tiny">XP: ${career.player.xp}</p>
        <div class="row" style="margin-top: 10px;">
          <button id="close-upgrade">Back</button>
        </div>
      `;
      showOverlay(modal);
      modal.querySelectorAll(".upgrade-button").forEach((button) => {
        button.addEventListener("click", () => {
          const stat = button.dataset.stat;
          const cost = upgradeCost(stat);
          if (career.player.xp >= cost && career.player.stats[stat] < 99) {
            career.player.xp -= cost;
            career.player.stats[stat] += 1;
            updatePlayerStats();
            saveCareer();
            showUpgradeMenu();
          }
        });
      });
      modal.querySelector("#close-upgrade").addEventListener("click", () => {
        hideOverlay();
        gameState.screen = "menu";
      });
    }

    function upgradeCost(stat) {
      const base = 40 + career.stageIndex * 20;
      const current = career.player.stats[stat];
      return Math.round(base + (current - 50) * 2);
    }

    function showPauseMenu() {
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.innerHTML = `
        <h2>Paused</h2>
        <p class="tiny">Adjust difficulty or resume.</p>
        <label>Difficulty</label>
        <select id="difficulty">
          <option value="0" ${career.difficulty === 0 ? "selected" : ""}>Rookie</option>
          <option value="1" ${career.difficulty === 1 ? "selected" : ""}>Varsity</option>
          <option value="2" ${career.difficulty === 2 ? "selected" : ""}>All-Pro</option>
        </select>
        <div class="row" style="margin-top: 12px;">
          <button id="resume">Resume</button>
          <button id="back-menu" class="secondary">Menu</button>
        </div>
      `;
      showOverlay(modal);
      modal.querySelector("#resume").addEventListener("click", () => {
        hideOverlay();
        gameState.paused = false;
      });
      modal.querySelector("#back-menu").addEventListener("click", () => {
        hideOverlay();
        gameState.paused = false;
        showMenu();
      });
      modal.querySelector("#difficulty").addEventListener("change", (event) => {
        career.difficulty = Number(event.target.value);
        saveCareer();
      });
    }

    function updateHud() {
      hudScoreboard.innerHTML = `
        <div class="tag">${stageName()}</div>
        <strong>${career.team.abbr} ${match.score.us} - ${match.score.them} ${career.currentOpponent?.abbr || "OPP"}</strong>
        <div>${career.team.name} vs ${career.currentOpponent?.name || "Opponent"}</div>
        <div>Q${match.quarter} • ${formatClock(match.clock)}</div>
      `;
      hudInfo.innerHTML = `Down ${match.down} &amp; ${match.yardsToGo} | OVR ${career.player.ovr}<br/>Week ${career.week}/${career.seasonLength}`;
      const xpPercent = Math.min(100, (career.player.xp / 600) * 100);
      hudXp.innerHTML = `XP ${career.player.xp}<div class="meter"><span style="width:${xpPercent}%"></span></div>`;

      careerSummary.innerHTML = `
        <div><span class="tag">${career.player.position}</span> ${career.player.name || "Rookie"}</div>
        <div>${career.team?.name || "Central HS"}</div>
        <div>Record: ${career.stageWins}-${career.stageLosses}</div>
        <div>Draft Stock: ${career.draftStock}</div>
        <div>${career.draftPick ? `Draft Pick: #${career.draftPick}` : ""}</div>
      `;

      playCallPanel.innerHTML = playbook
        .map((play) => `<div><strong>${play.id}. ${play.name}</strong><br/><span class="tiny">${play.description}</span></div>`)
        .join("");

      seasonActions.innerHTML = `
        <button id="play-game">Play Game</button>
        <button id="sim-game" class="secondary">Sim Game</button>
        <button id="fullscreen" class="secondary">Fullscreen</button>
        <div class="tiny">Opponent: ${career.currentOpponent?.name || "TBD"}</div>
        <div class="tiny">Last: ${career.results?.[career.week - 2]?.result || "—"} ${career.results?.[career.week - 2]?.score || ""}</div>
      `;

      const timeline = [
        `${CAREER_STAGES[0]}: ${career.stageIndex === 0 ? "Current" : "Complete"}`,
        `${CAREER_STAGES[1]}: ${career.stageIndex === 1 ? "Current" : career.stageIndex > 1 ? "Complete" : "Locked"}`,
        `${CAREER_STAGES[2]}: ${career.stageIndex === 2 ? "Current" : "Locked"}`,
        `Awards: ${career.totalAwards}`,
        `Next: ${career.currentOpponent?.abbr || "TBD"}`,
      ];
      timelinePanel.innerHTML = timeline.map((entry) => `<div>${entry}</div>`).join("");

      rosterPanel.innerHTML = career.roster
        .slice(0, 8)
        .map((playerInfo) => `<div>${playerInfo.position} ${playerInfo.name} <span class="tiny">OVR ${playerInfo.ovr}</span></div>`)
        .join("");
    }

    function formatClock(seconds) {
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60).toString().padStart(2, "0");
      return `${minutes}:${secs}`;
    }

    function simulateGame() {
      const base = career.player.ovr + career.stageIndex * 5;
      const opponent = 60 + career.stageIndex * 8 + Math.floor(Math.random() * 10);
      const ourScore = Math.max(0, Math.round((base / 15) + Math.random() * 3));
      const oppScore = Math.max(0, Math.round((opponent / 16) + Math.random() * 3));
      match.score.us = ourScore;
      match.score.them = oppScore;
      match.quarter = 4;
      match.clock = 0;
      endMatch();
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    function buildSprites() {
      const colors = [
        "#3cc5ff",
        "#4ad4ff",
        "#7ad1ff",
        "#2da0c6",
      ];
      spriteAssets.frames = colors.map((color, index) => {
        const spriteCanvas = document.createElement("canvas");
        spriteCanvas.width = 32;
        spriteCanvas.height = 32;
        const spriteCtx = spriteCanvas.getContext("2d");
        spriteCtx.fillStyle = color;
        spriteCtx.fillRect(8, 4, 16, 24);
        spriteCtx.fillStyle = "#0b2239";
        spriteCtx.fillRect(10, 6 + index, 12, 6);
        spriteCtx.fillStyle = "#fff";
        spriteCtx.fillRect(12, 10 + index, 4, 4);
        spriteCtx.fillRect(18, 10 + index, 4, 4);
        spriteCtx.fillStyle = "#e2b45f";
        spriteCtx.fillRect(13, 18 + index, 6, 8);
        return spriteCanvas;
      });
    }

    function drawSprite(entity, highlightColor) {
      if (!spriteAssets.frames.length) return;
      const frameIndex = Math.floor(Date.now() / 140) % spriteAssets.frames.length;
      const sprite = spriteAssets.frames[frameIndex];
      ctx.save();
      ctx.drawImage(sprite, entity.x - 16, entity.y - 16);
      if (highlightColor) {
        ctx.strokeStyle = highlightColor;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(entity.x, entity.y, entity.radius + 6, 0, Math.PI * 2);
        ctx.stroke();
      }
      ctx.restore();
    }

    function handleInput(dt) {
      if (gameState.paused || gameState.screen !== "game") return;
      const move = { x: 0, y: 0 };
      if (gameState.keys.has("ArrowUp") || gameState.keys.has("w")) move.y -= 1;
      if (gameState.keys.has("ArrowDown") || gameState.keys.has("s")) move.y += 1;
      if (gameState.keys.has("ArrowLeft") || gameState.keys.has("a")) move.x -= 1;
      if (gameState.keys.has("ArrowRight") || gameState.keys.has("d")) move.x += 1;
      const magnitude = Math.hypot(move.x, move.y) || 1;
      player.velocity.x = (move.x / magnitude) * player.speed;
      player.velocity.y = (move.y / magnitude) * player.speed;
      player.x = clamp(player.x + player.velocity.x * dt, 30, FIELD.width - 30);
      player.y = clamp(player.y + player.velocity.y * dt, 30, FIELD.height - 30);

      player.stamina = clamp(player.stamina + 12 * dt, 0, 100);
    }

    function updateGame(dt) {
      if (gameState.paused || gameState.screen !== "game") return;

      match.clock = Math.max(0, match.clock - dt);
      if (match.clock === 0) {
        if (match.quarter < 4) {
          match.quarter += 1;
          match.clock = match.quarterLength;
        } else {
          endMatch();
        }
        return;
      }

      if (match.playActive) {
        updateAi(dt);
      }

      if (match.ball.owner === "air" && match.airTarget) {
        const dx = match.airTarget.x - match.ball.x;
        const dy = match.airTarget.y - match.ball.y;
        const dist = Math.hypot(dx, dy) || 1;
        const speed = 260 + career.player.stats.skill * 1.8;
        match.ball.x += (dx / dist) * speed * dt;
        match.ball.y += (dy / dist) * speed * dt;
        if (dist < 10) {
          catchBall(match.airTarget);
          match.airTarget = null;
        }
      }

      if (player.tackleCooldown > 0) {
        player.tackleCooldown -= dt;
      }

      checkScores();
    }

    function updateAi(dt) {
      const difficulty = stageDifficulty();
      opponents.forEach((defender) => {
        const dx = player.x - defender.x;
        const dy = player.y - defender.y;
        const dist = Math.hypot(dx, dy) || 1;
        const speed = defender.speed * difficulty * 0.6;
        defender.x += (dx / dist) * speed * dt;
        defender.y += (dy / dist) * speed * dt;
        if (dist < defender.radius + player.radius + 6 && match.possession === "us") {
          handleTackle();
        }
      });

      teammates.forEach((mate, index) => {
        const lane = 120 + index * 120;
        mate.y -= 20 * dt;
        mate.x += Math.sin((Date.now() / 500) + index) * 12 * dt;
        mate.x = clamp(mate.x, 60, FIELD.width - 60);
        if (!player.hasBall && match.possession === "us") {
          const dx = mate.x - player.x;
          const dy = mate.y - player.y;
          if (Math.hypot(dx, dy) < 30) {
            catchBall(mate);
          }
        }
      });
    }

    function checkScores() {
      if (match.possession === "us" && player.hasBall && player.y < FIELD.endZoneHeight) {
        match.score.us += 1;
        match.playActive = false;
        match.message = "Touchdown!";
        resetPlay();
      }
      if (match.possession === "them" && match.ball.y > FIELD.height - FIELD.endZoneHeight) {
        match.score.them += 1;
        match.playActive = false;
        match.message = "Opponents scored.";
        resetPlay();
      }
    }

    function resetPlay() {
      match.down = 1;
      match.yardsToGo = 10;
      match.possession = "us";
      player.x = FIELD.width / 2;
      player.y = FIELD.height - 140;
      player.hasBall = true;
      match.ball.x = player.x;
      match.ball.y = player.y;
      match.ball.owner = "player";
      match.airTarget = null;
      player.stamina = 100;
      initActors();
    }

    function endMatch() {
      applyXp();
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.innerHTML = `
        <h2>Game Complete</h2>
        <p class="tiny">Final: ${match.score.us}-${match.score.them}</p>
        <p class="tiny">XP Earned: ${calculateXpGain()}</p>
        <div class="row">
          <button id="next-game">Continue</button>
          <button id="upgrade" class="secondary">Upgrade</button>
        </div>
      `;
      showOverlay(modal);
      modal.querySelector("#next-game").addEventListener("click", () => {
        hideOverlay();
        resetMatch();
      });
      modal.querySelector("#upgrade").addEventListener("click", showUpgradeMenu);
    }

    function handleTackle() {
      match.playActive = false;
      match.down += 1;
      match.yardsToGo = Math.max(1, match.yardsToGo - Math.floor(Math.random() * 6 + 2));
      player.x = FIELD.width / 2;
      player.y = FIELD.height - 140;
      player.hasBall = true;
      match.ball.x = player.x;
      match.ball.y = player.y;
      if (match.down > 4) {
        match.possession = "them";
        match.message = "Turnover on downs.";
        simulateOpponentDrive();
      }
    }

    function simulateOpponentDrive() {
      const driveOutcome = Math.random() < 0.45 ? "score" : "punt";
      if (driveOutcome === "score") {
        match.score.them += 1;
      }
      match.possession = "us";
      resetPlay();
    }

    function catchBall(receiver) {
      player.hasBall = true;
      match.ball.owner = "player";
      player.x = receiver.x;
      player.y = receiver.y;
    }

    function snapBall() {
      if (match.playActive) return;
      match.playActive = true;
      match.message = "";
      match.playType = playbook.find((play) => play.id === match.playType)?.type || "run";
    }

    function throwBall() {
      if (!match.playActive || !player.hasBall) return;
      if (career.player.position !== "QB") return;
      player.hasBall = false;
      match.ball.owner = "air";
      match.ball.x = player.x;
      match.ball.y = player.y;
      match.airTarget = teammates[1];
    }

    function runBall() {
      if (!match.playActive) return;
      if (career.player.position === "RB" || career.player.position === "WR") {
        player.speed += 40;
        player.stamina = Math.max(0, player.stamina - 20);
        setTimeout(() => {
          player.speed -= 40;
        }, 400);
      }
    }

    function tackle() {
      if (player.tackleCooldown > 0 || match.possession !== "them") return;
      const defender = { x: player.x, y: player.y, radius: player.radius };
      opponents.push(defender);
      player.tackleCooldown = 1;
    }

    function renderField() {
      const fieldTop = career.team?.colors?.[0] || "#0c6b2f";
      const fieldBottom = career.team?.colors?.[1] || "#0a4a22";
      ctx.fillStyle = "#0c6b2f";
      ctx.fillRect(0, 0, FIELD.width, FIELD.height);
      ctx.fillStyle = fieldTop;
      ctx.fillRect(0, 0, FIELD.width, FIELD.endZoneHeight);
      ctx.fillStyle = fieldBottom;
      ctx.fillRect(0, FIELD.height - FIELD.endZoneHeight, FIELD.width, FIELD.endZoneHeight);
      ctx.strokeStyle = "rgba(255,255,255,0.25)";
      ctx.lineWidth = 2;
      for (let y = FIELD.endZoneHeight; y < FIELD.height - FIELD.endZoneHeight; y += FIELD.hashSpacing) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(FIELD.width, y);
        ctx.stroke();
      }

      ctx.fillStyle = "rgba(255,255,255,0.6)";
      ctx.font = "bold 14px Trebuchet MS";
      ctx.textAlign = "center";
      for (let yard = 10; yard < 100; yard += 10) {
        const y = FIELD.height - FIELD.endZoneHeight - (yard / 100) * (FIELD.height - FIELD.endZoneHeight * 2);
        ctx.fillText(yard.toString(), 40, y);
        ctx.fillText(yard.toString(), FIELD.width - 40, y);
      }

      ctx.fillStyle = "rgba(0,0,0,0.35)";
      ctx.font = "bold 20px Trebuchet MS";
      ctx.fillText(career.team?.abbr || "HOME", FIELD.width / 2, FIELD.endZoneHeight / 1.5);
      ctx.fillText(career.currentOpponent?.abbr || "AWAY", FIELD.width / 2, FIELD.height - FIELD.endZoneHeight / 2.5);
    }

    function renderActors() {
      teammates.forEach((mate) => {
        drawSprite(mate);
      });
      opponents.forEach((defender) => {
        drawSprite(defender, "#ff5e5e");
      });

      drawSprite(player, positionTemplates[career.player.position]?.color || "#fff");

      if (match.ball.owner === "player") {
        ctx.fillStyle = "#d49a39";
        ctx.beginPath();
        ctx.arc(player.x + 10, player.y + 10, 5, 0, Math.PI * 2);
        ctx.fill();
      } else if (match.ball.owner === "air") {
        ctx.fillStyle = "#d49a39";
        ctx.beginPath();
        ctx.arc(match.ball.x, match.ball.y, 5, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function renderOverlayText() {
      if (match.message) {
        ctx.fillStyle = "rgba(0,0,0,0.6)";
        ctx.fillRect(FIELD.width / 2 - 120, FIELD.height / 2 - 30, 240, 60);
        ctx.fillStyle = "#fff";
        ctx.font = "bold 18px Trebuchet MS";
        ctx.textAlign = "center";
        ctx.fillText(match.message, FIELD.width / 2, FIELD.height / 2 + 6);
      }
    }

    function render() {
      ctx.clearRect(0, 0, FIELD.width, FIELD.height);
      renderField();
      renderActors();
      renderOverlayText();
    }

    function gameLoop(timestamp) {
      const dt = Math.min(0.05, (timestamp - gameState.lastTime) / 1000);
      gameState.lastTime = timestamp;
      handleInput(dt);
      updateGame(dt);
      render();
      updateHud();
      requestAnimationFrame(gameLoop);
    }

    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    window.addEventListener("keydown", (event) => {
      gameState.keys.add(event.key);
      if (event.key === "Escape") {
        if (gameState.screen === "creator") {
          showMenu();
          return;
        }
        gameState.paused = !gameState.paused;
        if (gameState.paused) {
          showPauseMenu();
        } else {
          hideOverlay();
        }
      }
      if (event.key === " " && gameState.screen === "game") {
        snapBall();
      }
      if (event.key === "f") {
        throwBall();
      }
      if (event.key === "r") {
        runBall();
      }
      if (event.key === "t") {
        tackle();
      }
      if (event.key === "1") {
        match.playType = 1;
      }
      if (event.key === "2") {
        match.playType = 2;
      }
      if (event.key === "3") {
        match.playType = 3;
      }
    });

    window.addEventListener("keyup", (event) => {
      gameState.keys.delete(event.key);
    });

    overlay.addEventListener("click", (event) => {
      if (event.target === overlay && gameState.screen === "creator") {
        showMenu();
      }
    });

    seasonActions.addEventListener("click", (event) => {
      if (event.target.id === "play-game") {
        hideOverlay();
        gameState.screen = "game";
      }
      if (event.target.id === "sim-game") {
        simulateGame();
      }
      if (event.target.id === "fullscreen") {
        toggleFullscreen();
      }
    });

    function init() {
      buildSprites();
      assignTeam();
      if (!career.roster?.length) generateRoster();
      if (!career.schedule?.length) generateSchedule();
      career.currentOpponent = career.schedule[career.week - 1];
      updatePlayerStats();
      resetMatch();
      showMenu();
      requestAnimationFrame(gameLoop);
    }

    init();
  </script>
</body>
</html>
